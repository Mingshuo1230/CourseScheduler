<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
    }
    
    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
    }
    
    .info-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      border-left: 4px solid #a29bfe;
    }
    
    .info-section p {
      margin-bottom: 10px;
      font-size: 16px;
      color: #34495e;
    }
    
    .info-section strong {
      color: #2c3e50;
    }
    
    .day-card {
      background: white;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .day-card:hover {
      border-color: #a29bfe;
      box-shadow: 0 10px 25px rgba(162, 155, 254, 0.15);
      transform: translateY(-2px);
    }
    
    .day-card h4 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .day-card h4::before {
      content: "üìÖ";
      margin-right: 10px;
      font-size: 20px;
    }
    
    .time-option {
      margin: 10px 0;
      padding: 12px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .time-option:hover {
      border-color: #a29bfe;
      background: #f8f9fa;
    }
    
    .time-option input[type="radio"] {
      margin-right: 12px;
      transform: scale(1.2);
    }
    
    .time-option input[type="radio"]:checked + span {
      color: #a29bfe;
      font-weight: 600;
    }
    
    .btn {
      background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 20px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(162, 155, 254, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .success-message {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
      color: white;
      border-radius: 15px;
      margin-top: 20px;
    }
    
    .success-message h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .success-message p {
      font-size: 18px;
      opacity: 0.9;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #a29bfe;
      font-size: 18px;
    }
    
    .error-message {
      background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
    }
  </style>
  <script>
    // Injected by doGet ‚Üí tpl.meetingId
    const meetingId = <?= JSON.stringify(meetingId) ?>;
    console.log('>>> student sees meetingId =', meetingId);

    window.onload = () => {
      const infoDiv  = document.getElementById('info');
      const timesDiv = document.getElementById('times');
      if (!meetingId) {
        infoDiv.innerHTML = '<div class="error-message">‚ùå Error: no course ID provided.</div>';
        return;
      }
      google.script.run
       .withSuccessHandler(meeting => {
         console.log('getCourse returned:', meeting);
         if (!meeting) {
           infoDiv.innerHTML = '<div class="error-message">‚ùå Error: no data returned for meeting.</div>';
           return;
         }
         populateForm(meeting);
       })
       .withFailureHandler(err => {
         console.error('getCourse failed:', err);
         infoDiv.innerHTML = '<div class="error-message">‚ùå Error loading course: ' + err.message + '</div>';
       })
       .getMeeting(meetingId);
    };

    function populateForm(m) {
      console.log('populateForm got:', m);
      const info = document.getElementById('info');
      const timesDiv = document.getElementById('times');
      
      if (!m) {
        info.innerHTML = '<div class="error-message">‚ùå Course not found or already completed.</div>';
        return;
      }
      
      info.innerHTML = `
        <div class="info-section">
          <p><strong>üè´ Course:</strong> ${m.course}</p>
          <p><strong>üè¢ Location:</strong> ${m.location}</p>
          <p><strong>üë®‚Äçüè´ Teacher:</strong> ${m.teacherName}</p>
          <p><strong>üìÖ Month:</strong> ${m.dateOptions}</p>
          <p><strong>‚è∞ Instructions:</strong> Choose up to ${m.maxSlots} time slots from the available times</p>
        </div>
      `;
      timesDiv.innerHTML = '';
      
      // Get teacher availability for this month
      google.script.run
        .withSuccessHandler(availabilityData => {
          displayAvailableTimes(availabilityData, m.maxSlots);
        })
        .withFailureHandler(err => {
          console.error('Failed to get teacher availability:', err);
          timesDiv.innerHTML = '<div class="error-message">‚ùå Error loading teacher availability. Please contact the administrator.</div>';
        })
        .getTeacherAvailabilityForMonth(m.teacherEmail, m.dateOptions);
    }

    function displayAvailableTimes(availabilityData, maxSlots) {
      const timesDiv = document.getElementById('times');
      
      if (!availabilityData || Object.keys(availabilityData).length === 0) {
        timesDiv.innerHTML = '<div class="error-message">‚è≥ No availability data found for this teacher and month.</div>';
        return;
      }
      
      let slotCount = 0;
      
      // Sort dates for better display
      const sortedDates = Object.keys(availabilityData).sort();
      
      sortedDates.forEach(date => {
        const dayData = availabilityData[date];
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-card';
        
        // Format date for display
        const displayDate = new Date(date).toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        dayDiv.innerHTML = `<h4>${displayDate}</h4>`;
        
        if (dayData.type === 'all-day') {
          // Generate time slots for all day (9 AM to 5 PM)
          const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
          timeSlots.forEach(time => {
            if (slotCount < maxSlots) {
              const timeDiv = document.createElement('div');
              timeDiv.className = 'time-option';
              
              const rb = document.createElement('input');
              rb.type = 'checkbox';
              rb.name = 'slot';
              rb.value = `${date}|${time}`;
              rb.onchange = function() {
                if (this.checked && slotCount >= maxSlots) {
                  this.checked = false;
                  alert(`You can only select up to ${maxSlots} time slots.`);
                  return;
                }
                slotCount += this.checked ? 1 : -1;
              };
              
              const timeSpan = document.createElement('span');
              timeSpan.textContent = `‚è∞ ${time}`;
              
              timeDiv.appendChild(rb);
              timeDiv.appendChild(timeSpan);
              dayDiv.appendChild(timeDiv);
            }
          });
        } else if (dayData.type === 'specific' && dayData.times && dayData.times.length > 0) {
          dayData.times.forEach(time => {
            if (slotCount < maxSlots) {
              const timeDiv = document.createElement('div');
              timeDiv.className = 'time-option';
              
              const rb = document.createElement('input');
              rb.type = 'checkbox';
              rb.name = 'slot';
              rb.value = `${date}|${time}`;
              rb.onchange = function() {
                if (this.checked && slotCount >= maxSlots) {
                  this.checked = false;
                  alert(`You can only select up to ${maxSlots} time slots.`);
                  return;
                }
                slotCount += this.checked ? 1 : -1;
              };
              
              const timeSpan = document.createElement('span');
              timeSpan.textContent = `‚è∞ ${time}`;
              
              timeDiv.appendChild(rb);
              timeDiv.appendChild(timeSpan);
              dayDiv.appendChild(timeDiv);
            }
          });
        }
        
        timesDiv.appendChild(dayDiv);
      });
    }

    function submitChoice() {
      const selectedSlots = document.querySelectorAll('input[name=slot]:checked');
      if (selectedSlots.length === 0) return alert('Please pick at least one time slot.');
      
      const selectedTimes = [];
      selectedSlots.forEach(slot => {
        const [selectedDay, selectedTime] = slot.value.split('|');
        selectedTimes.push({
          date: selectedDay,
          time: selectedTime
        });
      });
      
      google.script.run
        .withSuccessHandler(() => {
          document.body.innerHTML = `
            <div class="container">
              <div class="success-message">
                <h3>‚úÖ Time Slots Selected!</h3>
                <p>You have selected ${selectedTimes.length} time slot(s):</p>
                <ul style="text-align: left; margin: 20px 0;">
                  ${selectedTimes.map(slot => 
                    `<li><strong>${new Date(slot.date).toLocaleDateString('en-US', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })} at ${slot.time}</strong></li>`
                  ).join('')}
                </ul>
                <p>Your preferences have been sent to the teacher for confirmation.</p>
              </div>
            </div>
          `;
        })
        .withFailureHandler(err => {
          alert('Error submitting time slots: ' + err.message);
        })
        .submitStudentTimeSlots({
          id: meetingId,
          selectedTimes: selectedTimes
        });
    }
  </script>
</head>
<body>
  <div class="container">
    <h2>‚è∞ Select Your Final Time</h2>
    <div id="info" class="loading">‚è≥ Loading‚Ä¶</div>
    <div id="times"></div>
    <button class="btn" onclick="submitChoice()">‚úÖ Confirm</button>
  </div>
</body>
</html>
