<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }
      
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 40px;
      }
      
      h2 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 600;
      }
      
      .info-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        border-left: 4px solid #74b9ff;
      }
      
      .info-section p {
        margin-bottom: 10px;
        font-size: 16px;
        color: #34495e;
      }
      
      .info-section strong {
        color: #2c3e50;
      }
      
      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin: 20px 0;
      }
      
      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .calendar-header div {
        text-align: center;
        font-weight: 600;
        color: #2c3e50;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      
      .day-cell {
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        padding: 15px;
        min-height: 120px;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .day-cell:hover {
        border-color: #74b9ff;
        box-shadow: 0 5px 15px rgba(116, 185, 255, 0.2);
      }
      
      .day-number {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .availability-options {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      .availability-option {
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      
      .availability-option:hover {
        transform: scale(1.05);
      }
      
      .option-all-day {
        background: #00b894;
        color: white;
      }
      
      .option-not-available {
        background: #ff7675;
        color: white;
      }
      
      .option-specific {
        background: #fdcb6e;
        color: #2c3e50;
      }
      
      .option-selected {
        border: 2px solid #2c3e50;
        font-weight: 600;
      }
      
      .specific-times {
        margin-top: 10px;
        display: none;
      }
      
      .specific-times.show {
        display: block;
      }
      
      .time-input {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 11px;
        margin-bottom: 3px;
      }
      
      .btn {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 20px;
      }
      
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(116, 185, 255, 0.3);
      }
      
      .btn:active {
        transform: translateY(0);
      }
      
      .success-message {
        text-align: center;
        padding: 40px;
        background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        color: white;
        border-radius: 15px;
        margin-top: 20px;
      }
      
      .success-message h3 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      
      .success-message p {
        font-size: 18px;
        opacity: 0.9;
      }
      
      .loading {
        text-align: center;
        padding: 40px;
        color: #74b9ff;
        font-size: 18px;
      }
      
      .empty-day {
        background: #f8f9fa;
        color: #95a5a6;
      }
      
      .error-message {
        background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin: 20px 0;
      }
    </style>
    <script>
      // Injected by Code.gs
      const availabilityId = <?= JSON.stringify(availabilityId) ?>;
      console.log('Injected availabilityId:', availabilityId);

      let availabilityData = {};

      window.onload = function() {
        const info = document.getElementById('info');

        if (!availabilityId) {
          info.innerText = 'Error: no availability ID provided to the page.';
          return;
        }

        google.script.run
          .withSuccessHandler(populateCalendar)
          .withFailureHandler(err => {
            console.error('getTeacherAvailability failed:', err);
            info.innerHTML = '<div class="loading">‚ùå Error loading availability: ' + err.message + '</div>';
          })
          .getTeacherAvailability(availabilityId);
      };

      function populateCalendar(data) {
        console.log('populateCalendar got:', data);
        const info = document.getElementById('info');
        const calendarDiv = document.getElementById('calendar');

        // Check if data is valid
        if (!data || !data.teacherName || !data.month) {
          info.innerHTML = '<div class="error-message">‚ùå Error: Invalid availability data received. Please contact the administrator.</div>';
          return;
        }

        info.innerHTML = `
          <div class="info-section">
            <p><strong>üë®‚Äçüè´ Teacher:</strong> ${data.teacherName}</p>
            <p><strong>üìÖ Month:</strong> ${data.month}</p>
            <p><strong>‚è∞ Instructions:</strong> Click on each day to set your availability. You can choose "All Day Available", "Not Available", or "Specific Times" (and enter custom times).</p>
          </div>
        `;

        // Generate calendar for the month
        const [year, month] = data.month.split('-');
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        let calendarHTML = '<div class="calendar-header">';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
          calendarHTML += `<div>${day}</div>`;
        });
        calendarHTML += '</div><div class="calendar">';

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startDayOfWeek; i++) {
          calendarHTML += '<div class="day-cell empty-day"></div>';
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          calendarHTML += `
            <div class="day-cell" data-date="${dateStr}">
              <div class="day-number">${day}</div>
              <div class="availability-options">
                <div class="availability-option option-all-day" onclick="setAvailability('${dateStr}', 'all-day')">All Day</div>
                <div class="availability-option option-not-available" onclick="setAvailability('${dateStr}', 'not-available')">Not Available</div>
                <div class="availability-option option-specific" onclick="setAvailability('${dateStr}', 'specific')">Specific Times</div>
              </div>
              <div class="specific-times" id="specific-${dateStr}">
                <input type="time" class="time-input" placeholder="Time 1" onchange="updateSpecificTime('${dateStr}', 0, this.value)">
                <input type="time" class="time-input" placeholder="Time 2" onchange="updateSpecificTime('${dateStr}', 1, this.value)">
                <input type="time" class="time-input" placeholder="Time 3" onchange="updateSpecificTime('${dateStr}', 2, this.value)">
              </div>
            </div>
          `;
        }

        calendarHTML += '</div>';
        calendarDiv.innerHTML = calendarHTML;
      }

      function setAvailability(date, type) {
        const dayCell = document.querySelector(`[data-date="${date}"]`);
        const options = dayCell.querySelectorAll('.availability-option');
        const specificTimes = dayCell.querySelector('.specific-times');

        // Remove selected class from all options
        options.forEach(option => option.classList.remove('option-selected'));

        // Add selected class to clicked option
        const selectedOption = dayCell.querySelector(`.option-${type.replace('-', '-')}`);
        selectedOption.classList.add('option-selected');

        // Show/hide specific times input
        if (type === 'specific') {
          specificTimes.classList.add('show');
        } else {
          specificTimes.classList.remove('show');
        }

        // Store the availability data
        availabilityData[date] = {
          type: type,
          times: type === 'specific' ? ['', '', ''] : []
        };
      }

      function updateSpecificTime(date, index, time) {
        if (!availabilityData[date]) {
          availabilityData[date] = { type: 'specific', times: ['', '', ''] };
        }
        availabilityData[date].times[index] = time;
      }

      function submitAvailability() {
        // Filter out empty days and validate specific times
        const validAvailability = {};
        let hasSpecificTimes = false;

        for (const [date, data] of Object.entries(availabilityData)) {
          if (data.type === 'specific') {
            const validTimes = data.times.filter(time => time.trim() !== '');
            if (validTimes.length > 0) {
              validAvailability[date] = {
                type: 'specific',
                times: validTimes
              };
              hasSpecificTimes = true;
            }
          } else if (data.type !== 'not-available') {
            validAvailability[date] = data;
          }
        }

        if (Object.keys(validAvailability).length === 0) {
          return alert('Please set availability for at least one day.');
        }

        google.script.run
          .withSuccessHandler(() => {
            document.body.innerHTML = `
              <div class="container">
                <div class="success-message">
                  <h3>‚úÖ Availability Saved!</h3>
                  <p>Your availability for ${Object.keys(validAvailability).length} days has been saved.</p>
                </div>
              </div>
            `;
          })
          .withFailureHandler(err => {
            alert('Error saving availability: ' + err.message);
          })
          .submitTeacherAvailability({
            id: availabilityId,
            availability: validAvailability
          });
      }
    </script>
  </head>
  <body>
    <div class="container">
      <h2>üìÖ Set Your Availability</h2>

      <div id="info" class="loading">‚è≥ Loading‚Ä¶</div>

      <div id="calendar"></div>

      <button class="btn" onclick="submitAvailability()">üíæ Save Availability</button>
    </div>
  </body>
</html> 